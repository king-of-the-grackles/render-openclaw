# syntax=docker/dockerfile:1
# Extended Dockerfile with skill dependencies for Docker deployment
# Use this when you need skills that require external binaries (ffmpeg, gh, etc.)
#
# Multi-stage build: deps -> builder -> runtime
# Requires BuildKit (default since Docker 23.0)
#
# Build: docker build -f Dockerfile.skills -t openclaw:skills .
# Run:   docker compose -f docker-compose.yml -f docker-compose.skills.yml up -d

# ============================================
# Stage 1: DEPENDENCIES (cached when lockfile unchanged)
# ============================================
FROM node:22-bookworm AS deps

RUN corepack enable

WORKDIR /app

# Copy only files needed for dependency resolution
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches/ ./patches/
COPY scripts/ ./scripts/

# Workspace package.json files for pnpm resolution
# (COPY --parents requires newer BuildKit; use explicit paths instead)
COPY packages/clawdbot/package.json ./packages/clawdbot/
COPY packages/moltbot/package.json ./packages/moltbot/
COPY extensions/bluebubbles/package.json ./extensions/bluebubbles/
COPY extensions/copilot-proxy/package.json ./extensions/copilot-proxy/
COPY extensions/diagnostics-otel/package.json ./extensions/diagnostics-otel/
COPY extensions/discord/package.json ./extensions/discord/
COPY extensions/google-antigravity-auth/package.json ./extensions/google-antigravity-auth/
COPY extensions/google-gemini-cli-auth/package.json ./extensions/google-gemini-cli-auth/
COPY extensions/googlechat/package.json ./extensions/googlechat/
COPY extensions/imessage/package.json ./extensions/imessage/
COPY extensions/line/package.json ./extensions/line/
COPY extensions/llm-task/package.json ./extensions/llm-task/
COPY extensions/lobster/package.json ./extensions/lobster/
COPY extensions/matrix/package.json ./extensions/matrix/
COPY extensions/mattermost/package.json ./extensions/mattermost/
COPY extensions/memory-core/package.json ./extensions/memory-core/
COPY extensions/memory-lancedb/package.json ./extensions/memory-lancedb/
COPY extensions/minimax-portal-auth/package.json ./extensions/minimax-portal-auth/
COPY extensions/msteams/package.json ./extensions/msteams/
COPY extensions/nextcloud-talk/package.json ./extensions/nextcloud-talk/
COPY extensions/nostr/package.json ./extensions/nostr/
COPY extensions/open-prose/package.json ./extensions/open-prose/
COPY extensions/signal/package.json ./extensions/signal/
COPY extensions/slack/package.json ./extensions/slack/
COPY extensions/telegram/package.json ./extensions/telegram/
COPY extensions/tlon/package.json ./extensions/tlon/
COPY extensions/twitch/package.json ./extensions/twitch/
COPY extensions/voice-call/package.json ./extensions/voice-call/
COPY extensions/whatsapp/package.json ./extensions/whatsapp/
COPY extensions/zalo/package.json ./extensions/zalo/
COPY extensions/zalouser/package.json ./extensions/zalouser/

# Install all dependencies (dev + prod both needed for build stage)
# --ignore-scripts: postinstall scripts reference local files not present in deps stage
RUN --mount=type=cache,id=pnpm-store,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile --ignore-scripts

# ============================================
# Stage 2: BUILDER (runs when source changes)
# ============================================
FROM deps AS builder

# Install Bun (required for build scripts only, excluded from runtime)
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

# Copy full source
COPY . .

# Build CLI and UI
RUN OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build
# Force pnpm for UI build (Bun may fail on ARM/Synology architectures)
ENV OPENCLAW_PREFER_PNPM=1
RUN pnpm ui:build

# Strip devDependencies from node_modules for smaller runtime image.
# If this fails in workspace context, replace with:
#   RUN --mount=type=cache,id=pnpm-store,target=/root/.local/share/pnpm/store \
#       pnpm install --frozen-lockfile --prod
RUN CI=true pnpm prune --prod

# ============================================
# Stage 3: RUNTIME (slim image, no devDeps, no Bun)
# ============================================
FROM node:22-bookworm-slim AS runtime

# ---- Skill dependencies (apt packages) ----
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    # Core utilities
    curl \
    git \
    jq \
    unzip \
    ca-certificates \
    # Tailscale (for Serve/Funnel)
    gnupg \
    # Skills: video-frames
    ffmpeg \
    # Skills: github
    gh \
    # Skills: session-logs
    ripgrep \
    # Skills: tmux
    tmux \
    # Skills: Python-based (nano-banana-pro, local-places, openai-image-gen)
    python3 \
    python3-pip \
    python3-venv \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ---- Tailscale (for Serve/Funnel) ----
RUN curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg \
      | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null && \
    curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list \
      | tee /etc/apt/sources.list.d/tailscale.list && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tailscale && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ---- Python tools (uv for nano-banana-pro, local-places) ----
RUN pip3 install --break-system-packages uv

# ---- Node tools (mcporter for MCP server management) ----
RUN npm install -g mcporter

# ============================================
# GO TOOLS (optional - uncomment if needed for food-order skill)
# Adds ~500MB to image size
# ============================================
# RUN apt-get update && apt-get install -y golang && apt-get clean && rm -rf /var/lib/apt/lists/*
# ENV PATH="/root/go/bin:${PATH}"
# RUN go install github.com/steipete/ordercli/cmd/ordercli@latest

WORKDIR /app

# ---- Copy production artifacts from builder (COPY --chown avoids chown -R) ----
COPY --from=builder --chown=node:node /app/node_modules ./node_modules
COPY --from=builder --chown=node:node /app/dist ./dist
COPY --from=builder --chown=node:node /app/package.json ./package.json
COPY --from=builder --chown=node:node /app/openclaw.mjs ./openclaw.mjs

# ---- Copy source files needed at runtime (from build context) ----
# Extensions: needed for runtime plugin installation (npm install runs inside each)
COPY --chown=node:node extensions/ ./extensions/
# Skills: runtime skill definitions
COPY --chown=node:node skills/ ./skills/
# Docs: may be referenced at runtime
COPY --chown=node:node docs/ ./docs/
# Config: mcporter config, etc.
COPY --chown=node:node config/ ./config/
# Docker: entrypoint + bundled plugin list
COPY --chown=node:node docker/ ./docker/

# ---- Set up small runtime directories (fast chown on tiny dirs only) ----
RUN mkdir -p /home/node/.openclaw/extensions /home/node/.mcporter && \
    cp /app/config/mcporter.json /home/node/.mcporter/mcporter.json && \
    chown -R node:node /home/node/.openclaw /home/node/.mcporter && \
    mkdir -p /var/run/tailscale && chown node:node /var/run/tailscale

RUN chmod +x /app/docker/entrypoint.sh

ENV NODE_ENV=production

# Security: Run as non-root
USER node

# Use entrypoint for runtime plugin installation
ENTRYPOINT ["/app/docker/entrypoint.sh"]

# Start gateway server with default config
# --bind lan: required for Render health checks (and Tailscale Serve connects via localhost)
# --port 8080: Render expects this port
CMD ["node", "dist/index.js", "gateway", "--allow-unconfigured", "--bind", "lan", "--port", "8080"]
